<!DOCTYPE html>

<head>
	<meta charset="utf-8"/>
	<title>Скачане</title>

	<script src="webgl-fmi.js"></script>
	<script src="shaders.js"></script>
	
	<style>
		body   { text-align: center; }
		canvas { border: solid 1px DarkSlateGray; width:100%; height:100%; top:0; left:0; position:fixed; }
	</style>
	
	<script>
		function start( )
		{
			var	canvas = document.getElementById("picasso");
			canvas.addEventListener('webglcontextlost',function(event){event.preventDefault();},false);
			canvas.addEventListener('webglcontextrestored',init,false);
			document.body.addEventListener('keydown',keyDown,false);
			document.body.addEventListener('keyup',keyUp,false);
			
			init();
			drawFrame();
		}
		
		function Door(x,y,dx,dy)
		{
			var m = texIdentity();
			texScale(m,[1,6]);
			var style = {
				color: [1.2,1,0.9],
				texture: texFloor,
				texMatrix: m
			};
			var sx = 0.04+0.16*dy;
			var sy = 0.04+0.16*dx;
			others.push( custom(new Cuboid([x+dx/13,y+dy/13,0],[sx,sy,2]),style));
			others.push( custom(new Cuboid([x+12*dx/13,y+12*dy/13,0],[sx,sy,2]),style));
			style.rot = [0,45*dx,45*dy];
			others.push( custom(new Cuboid([x+dx/2,y+dy/2,1],[sx,sy,1.73]),style));
		}
		
		function Wall(x,y,dx,dy,narrow)
		{
			var zone = 0.3;
			var z = narrow?1.25:0;
			var dz = narrow?0.5:2;
			
			var w = new Cuboid([x+dx/2,y+dy/2,z],[dx?dx:0.31,dy?dy:0.31,dz]);
			w.color = [0.9,0.9,1];
			w.texture = texWall;
			var m = texIdentity();
			texScale(m,[0.8,1.6]);
			texScale(m,[dx>dy?dx/3:dy/3,dz/3]);
			w.texMatrix = m;
			
			if (!narrow)
			{
				w.x1 = w.center[0]-w.size[0]/2-zone;
				w.x2 = w.center[0]+w.size[0]/2+zone;
				w.y1 = w.center[1]-w.size[1]/2-zone;
				w.y2 = w.center[1]+w.size[1]/2+zone;
			}
			
			return w;
		}
		
		GEODESIC_SIDES = 0;
		function labyrinth(x1,x2,y1,y2)
		{
			var dx = x2-x1;
			var dy = y2-y1;
			var m = Math.max(dx,dy);
			var n = Math.min(dx,dy);
			
			// дъно на рекурсията, зоната е окончателна и
			// няма да бъде делена
			if (m<=10)
			{
				// добавяне на диамант във всяка стая
				diamonds.push( custom(new GeodesicSphere( [x1/2+x2/2,y1/2+y2/2,-0.2], 1/4 ),{
					rot:[0,0,0],
					color:[random(0.5,1.5),random(0.5,1.5),random(0.5,1.5)],
					collected:false
				}) ); 
				return;
			}

			m = 2*Math.round(random(3,m-3)/2);
			n = 2*Math.round(random(2,n-4)/2);

			if (dx>=dy)
			{
				wall.push( Wall(x1+m,y1,0,n+0.15) );
				wall.push( Wall(x1+m,y1+n+2-0.15,0,dy-n-2+0.15) );
				others.push( Wall(x1+m,y1,0,dy,true) );
				Door(x1+m,y1+n,0,2);
				labyrinth(x1,x1+m,y1,y2);
				labyrinth(x1+m,x2,y1,y2);
			}
			else
			{
				wall.push( Wall(x1,y1+m,n+0.15,0) );
				wall.push( Wall(x1+n+2-0.15,y1+m,dx-n-2+0.15,0) );
				others.push( Wall(x1,y1+m,dx,0,true) );
				Door(x1+n,y1+m,2,0);
				labyrinth(x1,x2,y1,y1+m);
				labyrinth(x1,x2,y1+m,y2);
			}
		}
		
		function init()
		{
			var cnv = document.getElementById("picasso");
			cnv.width = cnv.clientWidth;
			cnv.height = cnv.clientHeight;
			
			gl = getContext("picasso");
			glprog = getProgram(vShader,fShader);
			getVariables();

			gl.enable(gl.DEPTH_TEST);
			gl.clearColor(0,0,0,1);

			identity();
			perspective(30,gl.canvas.width/gl.canvas.height,0.2,10000);
			gl.uniform1i(uUseNormalMatrix,false);

			gl.uniform3f(uAmbientColor,0.5,0.5,0.5);
			gl.uniform3f(uDiffuseColor,1,1,1);
			gl.uniform3f(uLightDir,0,0,-1);

			// използваме модул №0 за текстури
			gl.uniform1i(uSampler, 0);
			gl.activeTexture(gl.TEXTURE0);
			texWall = loadTexture('Concrete_14_UV_H_CM_1.jpg');
			texFloor = loadTexture('Marble_05_UV_H_CM_1.jpg');

			explo = 0;
			
			//var m = texIdentity();
			//texScale(m,[5,5]);
			//texMat = m;

			wall = []; // стени, които избягваме
			others = []; // стени, които не избягваме
			diamonds = []; // диаманти за събиране
			
			// стени на лабиринта
			wall.push( Wall(-30,-20, 60, 0) );
			wall.push( Wall(-30, 20, 60, 0) );
			wall.push( Wall(-30,-20,  0,40) );
			wall.push( Wall( 30,-20,  0,40) );
			others.push( Wall(-30,-20, 60, 0, true) );
			others.push( Wall(-30, 20, 60, 0, true) );
			others.push( Wall(-30,-20,  0,40, true) );
			others.push( Wall( 30,-20,  0,40, true) );

			var m = texIdentity();
			texScale(m,[20,20]);
			others.push(custom(new Cuboid([0,0,-1.5],[60,40,1]),{texture: texFloor, texMatrix:m, color:[1,1,1]}));
			labyrinth(-30,30,-20,20);
			requestAnimationFrame(drawFrame);
		}

		sin = Math.sin;
		cos = Math.cos;
		
		pos = [5,5,0];
		dir = 0;
		dDir = 0;
		dPos = 0;
		kLeft = false;
		kRight = false;
		kForward = false;
		kBackward = false;
		jumpTime = -100;
		
		oldTime = now();
		function drawFrame()
		{
			time = now();
			dTime = time-oldTime;
			oldTime = time;

			gl.canvas.width = gl.canvas.offsetWidth;
			gl.canvas.height = gl.canvas.offsetHeight;
			gl.viewport(0,0,gl.canvas.width,gl.canvas.height);

			if (kLeft) dDir = +((kForward||kBackward)?0.8:1.6);
			if (kRight) dDir = -((kForward||kBackward)?0.8:1.6);
			dir += dDir*dTime;
			if (!kLeft && !kRight) dDir *= (1-5*dTime);
		
			
			if (kForward) dPos = 4;
			if (kBackward) dPos = -4;
			var newX = pos[0]+dPos*dTime*cos(dir);
			var newY = pos[1]+dPos*dTime*sin(dir);
			if (!kForward && !kBackward) dPos *= (1-5*dTime);
			
			if (kForward || kBackward)
			{
				// проверка за колизия със стена
				for (var i=0; i<wall.length; i++)
				{
					// колизия по X
					if (wall[i].x2>=newX && newX>=wall[i].x1 &&
						wall[i].y2>=pos[1] && pos[1]>=wall[i].y1)
					{
						newX = pos[0];
						break;
					}
				}
				for (var i=0; i<wall.length; i++)
				{
					// колизия по Y
					if (wall[i].y2>=newY && newY>=wall[i].y1 &&
						wall[i].x2>=pos[0] && pos[0]>=wall[i].x1)
					{
						newY = pos[1];
						break;
					}
				}
				pos[0] = newX;
				pos[1] = newY;
			}
			
			// проверка за хващане на диамант
			for (var i=0; i<diamonds.length; i++)
			{
				if ( Math.abs(pos[0]-diamonds[i].center[0])<1 &&
					 Math.abs(pos[1]-diamonds[i].center[1])<1 )
				{
					diamonds[i].size = 20;
					diamonds[i].collected = true;
					explo = 1;
					break;
				}
			}
			
			identity();
			perspective(30,gl.canvas.width/gl.canvas.height,0.2,10000);

			// експлозия - цвят на фона и осветяване на цялата сцена
			gl.uniform1f(uExplosion,explo);
			gl.clearColor(explo,explo,explo,1);
			explo *= (1-dTime);
			
			gl.clear(gl.COLOR_BUFFER_BIT+gl.DEPTH_BUFFER_BIT);

			var jumpZ = 0;
			gl.uniform1f(uFog,15.0);
			if (time-jumpTime<=2)
			{
				jumpZ = 6*sin(Math.PI*(time-jumpTime)/2);
				gl.uniform1f(uFog,15.0+3*jumpZ);
			}
			jumpZ += 0.01*sin(3*time); 
			
			lookAt( 
					[pos[0]-0.1*cos(dir),pos[1]-0.1*sin(dir),jumpZ],
					[pos[0]+20*cos(dir),pos[1]+20*sin(dir),-1],
					[0,0,1] );
					

			gl.uniform1i(uUseTexture,true);
			for (var i=0; i<wall.length; i++)
			{
				wall[i].draw();
			}
			for (var i=0; i<others.length; i++)
			{
				others[i].draw();
			}

			for (var i=0; i<diamonds.length; i++)
			{
				diamonds[i].rot[0] += 50*sin(i+0.5)*dTime;
				diamonds[i].rot[1] += 80*cos(i+1.5)*dTime;
				diamonds[i].rot[2] += 110*sin(i-0.5)*dTime;
			}

			// рисуване на диаманти в лабиринта
			gl.uniform1i(uUseTexture,false);
			gl.disableVertexAttribArray(aST);
			for (var i=0; i<diamonds.length; i++)
				if (!diamonds[i].collected)
					diamonds[i].draw();
			
			// рисуване на събраните диаманти
			ortho(gl.canvas.width,gl.canvas.height,-1000,1000);
			gl.clear(gl.DEPTH_BUFFER_BIT);
			lookAt([0,0,1000],[0,0,0],[0,1,0]);
			var dX=Math.round(gl.canvas.width/2/50)*50-50;
			var x=-dX;
			var y=-Math.round(gl.canvas.height/2/50)*50+50;
			for (var i=0; i<diamonds.length; i++)
				if (diamonds[i].collected)
				{
					diamonds[i].center = [x,y,0];
					diamonds[i].draw();
					x += 50;
					if (x>dX) {x=-dX; y+=50;}
				}
				
			requestAnimationFrame(drawFrame);
		}
		
	function keyDown(event)
	{
		// стрелка наляво
		if (event.keyCode==37) kLeft = true, kRight = false;

		// стрелка напред
		if (event.keyCode==38) kForward = true, kBackward = false;

		// стрелка надясно
		if (event.keyCode==39) kRight = true, kLeft = false;

		// стрелка назад
		if (event.keyCode==40) kForward = false, kBackward = true;

		// интервал
		if (event.keyCode==32) jumpTime = now();
	}
		
	function keyUp(event)
	{
		// стрелка наляво
		if (event.keyCode==37) kLeft = false;

		// стрелка напред
		if (event.keyCode==38) kForward = false;

		// стрелка надясно
		if (event.keyCode==39) kRight = false;

		// стрелка назад
		if (event.keyCode==40) kBackward = false;
	}
	
	</script>
</head>

<body onload="start()">
	<noscript>
		Искаме JavaScript, но няма!
	</noscript>
	
	<canvas id="picasso">
		Искаме canvas, но няма!
	</canvas>
</body>
