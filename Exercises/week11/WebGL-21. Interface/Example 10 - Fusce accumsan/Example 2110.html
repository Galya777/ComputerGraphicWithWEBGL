<!DOCTYPE html>

<head>
	<meta charset="utf-8"/>
	<title>Fusce accumsan</title>

	<script src="webgl-fmi.js"></script>
	<script src="shaders.js"></script>
	
	<style>
		canvas {
			position: fixed;
			top: 0px;
			left: 0px;
			width: 100%;
			height: 100%;
		}
	</style>
	
	<script>
		function start( )
		{
			var	canvas = document.getElementById("picasso");
			canvas.addEventListener('webglcontextlost',function(event){event.preventDefault();},false);
			canvas.addEventListener('webglcontextrestored',function(){init();},false);

			// улавяме всички опити за промяна на размера
			window.addEventListener('resize',resized,false);

			init();
		}
		
		function init()
		{
			gl = getContext("picasso");
			glprog = getProgram(vShader,fShader);
			getVariables();

			gl.enable(gl.DEPTH_TEST);
			gl.clearColor(0,0,0,1);

			identity();
			gl.uniform1i(uUseNormalMatrix,false);

			gl.uniform3f(uAmbientColor,0.2,0.2,0.2);
			gl.uniform3f(uDiffuseColor,1,1,1);
			gl.uniform3f(uSpecularColor,1,1,1);
			gl.uniform1f(uShininess,5);
			gl.uniform3f(uLightDir,0,0,-1);

			// дефиниране на топка
			SPHERE_SIDES = 32;
			ball = new Sphere([0,0,0],1);

			// симулираме промяна на размера на прозореца,
			// за да инициализираме правилно размерите
			resized();
		}

		// рисуване в правоъгълник (x0,y0)-(x1,y1)
		function drawBalls(level,x0,y0,x1,y1)
		{
			// намираме радиуса R на централната сфера и
			// работим нататък само ако е поне 3 пиксела
			var dx = (x1-x0);
			var dy = (y1-y0);
			var R = Math.min(dx,dy)/2;

			if (R<2) return;

			// рисуваме централната сфера с цвят, който
			// зависи от нивото на рекурсията level
			ball.color = [0.5+0.5*sin(1.2*level),0.5+0.5*sin(1.2*level+2*PI/3),0.5+0.5*sin(1.2*level+4*PI/3)];
			ball.center = [(x0+x1)/2,(y0+y1)/2,0];
			ball.size = R;
			ball.draw();
			
			// изчисляваме размера на квадратчетата във
			// върховете, където ще са 4-те малки сфери...
			var r = 2*R*(Math.sqrt(2)-1)/(Math.sqrt(2)+1);
			var cx = ball.center[0];
			var cy = ball.center[1];
			
			// ...и ги рисуваме
			drawBalls(level-1,cx-R,cy-R,cx-R+r,cy-R+r);
			drawBalls(level-1,cx-R,cy+R-r,cx-R+r,cy+R);
			drawBalls(level-1,cx+R-r,cy-R,cx+R,cy-R+r);
			drawBalls(level-1,cx+R-r,cy+R-r,cx+R,cy+R);
			
			// рекурсивно обработваме двата участъка встрани
			// от централната сфера
			var size = Math.abs(dx-dy)/2;
			if (size<2) return;
			if (dx>=dy)
			{
				// те са отляво и отдясно на нея
				drawBalls(level-1,x1-size,y0,x1,y1);
				drawBalls(level-1,x0,y0,x0+size,y1);
			}
			else
			{
				// те са отгоре и отдолу на нея
				drawBalls(level-1,x0,y1-size,x1,y1);
				drawBalls(level-1,x0,y0,x1,y0+size);
			}
		}
		
		// рисуване на кадър без автоматично преизвикване
		function drawFrame()
		{
			gl.clear(gl.COLOR_BUFFER_BIT+gl.DEPTH_BUFFER_BIT);
			lookAt([0,0,15],[0,0,0],[0,1,0]);
			drawBalls(7,-gl.canvas.width/2,-gl.canvas.height/2,gl.canvas.width/2,gl.canvas.height/2);
		}
		
		// размерът на екрана е променен
		function resized()
		{
			// вземаме текущия адрес
			gl.canvas.width = gl.canvas.offsetWidth;
			gl.canvas.height = gl.canvas.offsetHeight;
				
			// подаваме го на WebGL
			gl.viewport(0,0,gl.canvas.width,gl.canvas.height);
				
			// актуализираме проекцията
			var proj = orthoMatrix(gl.canvas.width,gl.canvas.height,-1000,1000);
			gl.uniformMatrix4fv(uProjectionMatrix,false,proj);
				
			// предизвикваме прерисуване на сцената
			requestAnimationFrame(drawFrame);
		}
	</script>
</head>

<body onload="start()">
	<noscript>
		Искаме JavaScript, но няма!
	</noscript>
	<canvas id="picasso">
		Искаме canvas, но няма!
	</canvas>
</body>
